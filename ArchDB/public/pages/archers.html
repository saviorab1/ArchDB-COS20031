<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèπ Archer Management - Archery Score System</title>
    <link href="../css/styles.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="../js/archery.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/ui.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="../index.html" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; color: inherit;">
                    <img src="../css/ArchDB_logo.png" alt="ArchDB Logo" class="logo-img">
                    <span class="brand-text">Archery Score System</span>
                </a>
            </div>
            <div class="nav-links" id="nav-links">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="archers.html" class="nav-link active">Archers</a>
                <a href="scores.html" class="nav-link">Scores</a>
                <a href="competitions.html" class="nav-link">Competitions</a>
                <a href="results.html" class="nav-link">Results</a>
                <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
                    <span id="user-info" style="color: white; font-size: 14px;"></span>
                    <button onclick="logout()" style="padding: 8px 20px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title" id="page-title">Archer Management</h1>
            <p class="page-subtitle" id="page-subtitle">Manage archers and track their profiles</p>
        </div>
    </section>

    <main class="container" style="padding: 2rem 0;">
        <!-- Actions Bar - Only show for managers -->
        <div class="actions-bar" id="manager-actions" style="display: none;">
            <div class="search-filter">
                <input type="text" id="search-archers" placeholder="Search by name..." class="search-input">
                <select id="filter-equipment" class="filter-select">
                    <option value="">All Equipment</option>
                    <option value="RECURVE">Recurve</option>
                    <option value="COMPOUND">Compound</option>
                    <option value="RECURVE_BAREBOW">Barebow (Recurve)</option>
                    <option value="COMPOUND_BAREBOW">Barebow (Compound)</option>
                    <option value="LONGBOW">Longbow</option>
                </select>
            </div>
            <button onclick="showAddArcherModal()" class="btn btn-primary">+ Add Archer</button>
        </div>

        <!-- Archer Profile (for archers) -->
        <div id="archer-profile" class="profile-section" style="display: none;">
            <div class="profile-card">
                <div class="profile-header">
                    <h2 id="archer-name">Your Profile</h2>
                    <span class="badge badge-active">Active</span>
                </div>
                <div class="profile-details" id="archer-details">
                    <!-- Profile details will be loaded here -->
                </div>
                <div class="profile-actions">
                    <button onclick="editOwnProfile()" class="btn btn-primary" id="edit-profile-btn">Edit Profile</button>
                    <button onclick="saveProfileChanges()" class="btn btn-primary" id="save-profile-btn" style="display: none;">Save Changes</button>
                    <button onclick="cancelProfileEdit()" class="btn btn-secondary" id="cancel-profile-btn" style="display: none;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Archers Table (for managers) -->
        <div class="table-card" id="archers-table" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Equipment</th>
                        <th>Category</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="archers-list">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add/Edit Archer Modal -->
    <div id="archer-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Archer</h2>
                <button class="modal-close" onclick="hideArcherModal()">&times;</button>
            </div>
            <form id="archer-form" class="modal-form">
                <input type="hidden" name="archerId" id="archerId">
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" name="firstName" required>
                </div>

                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" name="lastName" required>
                </div>

                <div class="form-group">
                    <label>Gender *</label>
                    <select name="gender" id="gender" required onchange="updateCategoryDisplay()">
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date of Birth *</label>
                    <input type="date" name="dateOfBirth" id="birthDate" required onchange="updateCategoryDisplay()">
                </div>

                <div class="form-group">
                    <label>Equipment *</label>
                    <select name="equipment" id="equipment" required onchange="updateCategoryDisplay()">
                        <option value="RECURVE">Recurve</option>
                        <option value="COMPOUND">Compound</option>
                        <option value="BAREBOW">Barebow</option>
                        <option value="LONGBOW">Longbow</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <div class="category-display" id="category-display">
                        Select gender and birth date
                    </div>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>

                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" name="phoneNumber">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideArcherModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Archer</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <script>
        let currentUserRole = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('../../api/check_auth.php', {
                    credentials: 'include'
                });

                if (!response.ok || response.status === 401) {
                    // Not authenticated, redirect to login
                    window.location.href = '../login.html';
                    return false;
                }

                const data = await response.json();
                if (data.authenticated) {
                    // Display user info
                    currentUserRole = data.user.role;
                    const userRole = data.user.role === 'archer' ? 'üèπ Archer' : 'üéØ Manager';
                    document.getElementById('user-info').textContent = userRole;
                    return true;
                } else {
                    window.location.href = '../login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '../login.html';
                return false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('../../api/logout.php', {
                    method: 'GET',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '../login.html';
        }

        // Load archers data
        async function loadArchers() {
            try {
                const response = await fetch('../../api/get_archers.php', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load archers');
                }

                const data = await response.json();
                if (data.success) {
                    displayArchers(data.archers, data.user_role);
                } else {
                    showNotification('Failed to load archers', 'error');
                }
            } catch (error) {
                console.error('Error loading archers:', error);
                showNotification('Error loading archers', 'error');
            }
        }

        // Store current archer data for editing
        let currentArcherData = null;
        let allArchersData = []; // Store all archers data for managers

        // Display archers based on user role
        function displayArchers(archers, userRole) {
            if (userRole === 'archer') {
                // Show single archer profile
                document.getElementById('page-title').textContent = 'My Profile';
                document.getElementById('page-subtitle').textContent = 'View and manage your archery profile';
                document.getElementById('archer-profile').style.display = 'block';
                document.getElementById('archers-table').style.display = 'none';
                document.getElementById('manager-actions').style.display = 'none';

                if (archers.length > 0) {
                    const archer = archers[0];
                    currentArcherData = archer; // Store for editing
                    allArchersData = archers; // Store all archers data
                    document.getElementById('archer-name').textContent = archer.full_name;

                    renderArcherProfile(archer, false); // false = not in edit mode
                }
            } else {
                // Show all archers table for managers
                document.getElementById('page-title').textContent = 'Archer Management';
                document.getElementById('page-subtitle').textContent = 'Manage archers and track their profiles';
                document.getElementById('archer-profile').style.display = 'none';
                document.getElementById('archers-table').style.display = 'block';
                document.getElementById('manager-actions').style.display = 'flex';

                // Store all archers data for editing
                allArchersData = archers;

                const tbody = document.getElementById('archers-list');
                tbody.innerHTML = '';

                if (archers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No archers found</td></tr>';
                    return;
                }

                archers.forEach(archer => {
                    const row = document.createElement('tr');
                    const actionsHtml = currentUserRole === 'manager' ? `
                        <button class="btn-icon" onclick="editArcher(${archer.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteArcher(${archer.id})" title="Delete">üóëÔ∏è</button>
                    ` : '-';

                    row.innerHTML = `
                        <td><strong>${archer.full_name}</strong></td>
                        <td>${archer.gender_display}</td>
                        <td>${archer.equipment_display}</td>
                        <td>${archer.category_display}</td>
                        <td>${archer.email || 'N/A'}</td>
                        <td>${actionsHtml}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuth().then(isAuthenticated => {
                if (!isAuthenticated) {
                    return;
                }

                // Global HTMX config
                htmx.config.globalViewTransitions = true;
                htmx.config.useTemplateFragments = true;

                // Global error handling
                document.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.xhr.status >= 400) {
                        showNotification('An error occurred. Please try again.', 'error');
                    }
                });

                // Load archers data
                loadArchers();
            });
        });

        function showAddArcherModal() {
            document.getElementById('modal-title').textContent = 'Add New Archer';
            document.getElementById('archer-form').reset();
            document.getElementById('archer-modal').style.display = 'block';
            updateCategoryDisplay();
        }

        function hideArcherModal() {
            document.getElementById('archer-modal').style.display = 'none';
        }

        function editArcher(id) {
            // Only allow managers to edit archers
            if (currentUserRole !== 'manager') {
                showNotification('You do not have permission to edit archers', 'error');
                return;
            }

            // Find the archer data
            const archerData = allArchersData.find(archer => archer.id == id);
            if (!archerData) {
                showNotification('Archer not found', 'error');
                return;
            }

            // Populate the modal with archer data
            document.getElementById('modal-title').textContent = 'Edit Archer';
            document.getElementById('archer-form').reset();

            // Set form values
            const form = document.getElementById('archer-form');
            form.archerId.value = archerData.id;
            form.firstName.value = archerData.first_name;
            form.lastName.value = archerData.last_name;
            form.gender.value = archerData.gender === 'Male' ? 'M' : 'F';
            form.dateOfBirth.value = archerData.date_of_birth;
            form.equipment.value = archerData.equipment;
            form.email.value = archerData.email || '';
            form.phoneNumber.value = archerData.phone_number || '';

            // Update category display
            updateCategoryDisplay();

            // Show modal
            document.getElementById('archer-modal').style.display = 'block';
        }

        // Render archer profile (read-only or editable)
        function renderArcherProfile(archer, isEditing) {
            const detailsHtml = `
                <div class="profile-item">
                    <span class="label">First Name:</span>
                    ${isEditing ?
                        `<input type="text" id="edit-first-name" value="${archer.first_name}" class="profile-input">` :
                        `<span>${archer.first_name}</span>`
                    }
                </div>
                <div class="profile-item">
                    <span class="label">Last Name:</span>
                    ${isEditing ?
                        `<input type="text" id="edit-last-name" value="${archer.last_name}" class="profile-input">` :
                        `<span>${archer.last_name}</span>`
                    }
                </div>
                <div class="profile-item">
                    <span class="label">Gender:</span>
                    <span>${archer.gender_display}</span>
                </div>
                <div class="profile-item">
                    <span class="label">Date of Birth:</span>
                    <span>${new Date(archer.date_of_birth).toLocaleDateString()}</span>
                </div>
                <div class="profile-item">
                    <span class="label">Age:</span>
                    <span>${archer.age} years old</span>
                </div>
                <div class="profile-item">
                    <span class="label">Equipment:</span>
                    <span>${archer.equipment_display}</span>
                </div>
                <div class="profile-item">
                    <span class="label">Category:</span>
                    <span>${archer.age_group} ${archer.gender_display} ${archer.equipment_display}</span>
                </div>
                <div class="profile-item">
                    <span class="label">Email:</span>
                    ${isEditing ?
                        `<input type="email" id="edit-email" value="${archer.email || ''}" class="profile-input">` :
                        `<span>${archer.email || 'Not provided'}</span>`
                    }
                </div>
                <div class="profile-item">
                    <span class="label">Phone:</span>
                    ${isEditing ?
                        `<input type="tel" id="edit-phone" value="${archer.phone_number || ''}" class="profile-input">` :
                        `<span>${archer.phone_number || 'Not provided'}</span>`
                    }
                </div>
                <div class="profile-item">
                    <span class="label">Member Since:</span>
                    <span>${new Date(archer.created_at).toLocaleDateString()}</span>
                </div>
            `;
            document.getElementById('archer-details').innerHTML = detailsHtml;
        }

        // Start editing profile
        function editOwnProfile() {
            if (!currentArcherData) return;

            renderArcherProfile(currentArcherData, true);
            document.getElementById('edit-profile-btn').style.display = 'none';
            document.getElementById('save-profile-btn').style.display = 'inline-block';
            document.getElementById('cancel-profile-btn').style.display = 'inline-block';
        }

        // Save profile changes
        async function saveProfileChanges() {
            if (!currentArcherData) return;

            const firstName = document.getElementById('edit-first-name').value.trim();
            const lastName = document.getElementById('edit-last-name').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();

            if (!firstName || !lastName) {
                showNotification('First name and last name are required', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('archer_id', currentArcherData.id);
                formData.append('first_name', firstName);
                formData.append('last_name', lastName);
                formData.append('email', email);
                formData.append('phone_number', phone);

                const response = await fetch('../../api/update_archer.php', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Update current data and refresh display
                    currentArcherData.first_name = firstName;
                    currentArcherData.last_name = lastName;
                    currentArcherData.email = email;
                    currentArcherData.phone_number = phone;
                    currentArcherData.full_name = `${firstName} ${lastName}`;
                    document.getElementById('archer-name').textContent = currentArcherData.full_name;
                    renderArcherProfile(currentArcherData, false);
                    cancelProfileEdit();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
            }
        }

        // Cancel profile editing
        function cancelProfileEdit() {
            renderArcherProfile(currentArcherData, false);
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
            document.getElementById('save-profile-btn').style.display = 'none';
            document.getElementById('cancel-profile-btn').style.display = 'none';
        }

        async function deleteArcher(id) {
            // Only allow managers to delete archers
            if (currentUserRole !== 'manager') {
                showNotification('You do not have permission to delete archers', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this archer? This action cannot be undone.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('archer_id', id);

                const response = await fetch('../../api/delete_archer.php', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Refresh the archers list
                    loadArchers();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete archer. Please try again.', 'error');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('archer-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>