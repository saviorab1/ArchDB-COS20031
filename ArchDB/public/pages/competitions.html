<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèπ Competition Management - Archery Score System</title>
    <link href="../css/styles.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="../js/archery.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/ui.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="../index.html" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; color: inherit;">
                    <img src="../css/ArchDB_logo.png" alt="ArchDB Logo" class="logo-img">
                    <span class="brand-text">Archery Score System</span>
                </a>
            </div>
            <div class="nav-links" id="nav-links">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="archers.html" class="nav-link">Archers</a>
                <a href="scores.html" class="nav-link">Scores</a>
                <a href="competitions.html" class="nav-link active">Competitions</a>
                <a href="results.html" class="nav-link">Results</a>
                <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
                    <span id="user-info" style="color: white; font-size: 14px;"></span>
                    <button onclick="logout()" style="padding: 8px 20px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title" id="page-title">Competition Management</h1>
            <p class="page-subtitle" id="page-subtitle">Create, manage and track competitions</p>
        </div>
    </section>

    <main class="container" style="padding: 2rem 0;">
        <!-- Actions Bar - Only show for managers -->
        <div class="actions-bar" id="manager-actions" style="display: none;">
            <h2 style="color: #1a365d; margin: 0;">Competitions</h2>
            <button onclick="showAddCompetitionModal()" class="btn btn-primary">+ Create Competition</button>
        </div>

        <!-- Competition Filter - Show for both roles -->
        <div class="actions-bar" id="competition-filter">
            <div class="filter-options">
                <button onclick="filterCompetitions('all')" class="btn btn-secondary filter-btn active" id="filter-all">All Competitions</button>
                <button onclick="filterCompetitions('upcoming')" class="btn btn-secondary filter-btn" id="filter-upcoming">Upcoming</button>
                <button onclick="filterCompetitions('past')" class="btn btn-secondary filter-btn" id="filter-past">Past</button>
            </div>
        </div>

        <!-- Competitions Grid -->
        <div class="competitions-grid" id="competitions-grid">
            <!-- Competitions will be loaded dynamically -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-content">
                <div class="empty-icon">üèπ</div>
                <h3>No competitions found</h3>
                <p id="empty-message">There are no competitions matching your criteria.</p>
            </div>
        </div>

        </div>
    </main>

    <!-- Add/Edit Competition Modal -->
    <div id="competition-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="modal-title">Create New Competition</h2>
                <button class="modal-close" onclick="hideCompetitionModal()">&times;</button>
            </div>
            <form id="competition-form" class="modal-form">
                <div class="form-group">
                    <label>Competition Name *</label>
                    <input type="text" name="name" required placeholder="e.g., Swinburne Championship">
                </div>

                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" name="date" required>
                </div>

                <div class="form-group">
                    <label>Location *</label>
                    <input type="text" name="location" required placeholder="e.g., Swinburne Campus">
                </div>

                <div class="form-group">
                    <label>Round *</label>
                    <select name="roundId" required>
                        <option value="">Select Round</option>
                        <option value="1">WA 1440</option>
                        <option value="2">FITA 70m</option>
                        <option value="3">Indoor 18m</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Optional competition details..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCompetitionModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Competition</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <script>
        let currentUserRole = null;
        let allCompetitions = [];
        let currentFilter = 'all';

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('../../api/check_auth.php', {
                    credentials: 'include'
                });

                if (!response.ok || response.status === 401) {
                    // Not authenticated, redirect to login
                    window.location.href = '../login.html';
                    return false;
                }

                const data = await response.json();
                if (data.authenticated) {
                    // Display user info
                    currentUserRole = data.user.role;
                    const userRole = data.user.role === 'archer' ? 'üèπ Archer' : 'üéØ Manager';
                    document.getElementById('user-info').textContent = userRole;
                    return true;
                } else {
                    window.location.href = '../login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '../login.html';
                return false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('../../api/logout.php', {
                    method: 'GET',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '../login.html';
        }

        // Load competitions data
        async function loadCompetitions() {
            try {
                const response = await fetch('../../api/get_competitions.php', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load competitions');
                }

                const data = await response.json();
                if (data.success) {
                    allCompetitions = data.competitions;
                    displayCompetitions(data.competitions, data.user_role);
                } else {
                    showNotification('Failed to load competitions', 'error');
                }
            } catch (error) {
                console.error('Error loading competitions:', error);
                showNotification('Error loading competitions', 'error');
            }
        }

        // Display competitions based on user role
        function displayCompetitions(competitions, userRole) {
            if (userRole === 'archer') {
                // Show archer interface
                document.getElementById('page-title').textContent = 'Available Competitions';
                document.getElementById('page-subtitle').textContent = 'Browse and register for upcoming competitions';
                document.getElementById('manager-actions').style.display = 'none';
            } else {
                // Show manager interface
                document.getElementById('page-title').textContent = 'Competition Management';
                document.getElementById('page-subtitle').textContent = 'Create, manage and track competitions';
                document.getElementById('manager-actions').style.display = 'flex';
            }

            const filteredCompetitions = filterCompetitionsByType(competitions, currentFilter);
            renderCompetitionCards(filteredCompetitions, userRole);
        }

        // Filter competitions by type
        function filterCompetitionsByType(competitions, filterType) {
            if (filterType === 'all') return competitions;

            return competitions.filter(comp => {
                if (filterType === 'upcoming') return comp.competition_status === 'upcoming';
                if (filterType === 'past') return comp.competition_status === 'past';
                return true;
            });
        }

        // Render competition cards
        function renderCompetitionCards(competitions, userRole) {
            const grid = document.getElementById('competitions-grid');
            const emptyState = document.getElementById('empty-state');

            if (competitions.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                const message = currentFilter === 'all' ? 'There are no competitions available.' :
                               currentFilter === 'upcoming' ? 'There are no upcoming competitions.' :
                               'There are no past competitions.';
                document.getElementById('empty-message').textContent = message;
                return;
            }

            emptyState.style.display = 'none';
            grid.innerHTML = '';

            competitions.forEach(competition => {
                const card = createCompetitionCard(competition, userRole);
                grid.appendChild(card);
            });
        }

        // Create competition card
        function createCompetitionCard(competition, userRole) {
            const card = document.createElement('div');
            card.className = 'competition-card';

            const badgeClass = competition.competition_status === 'upcoming' ? 'badge-upcoming' :
                              competition.competition_status === 'past' ? 'badge-completed' : 'badge-current';
            const badgeText = competition.competition_status === 'upcoming' ? 'Upcoming' :
                             competition.competition_status === 'past' ? 'Completed' : 'Current';

            let actionsHtml = '';

            if (userRole === 'archer') {
                // Archer actions
                if (competition.competition_status === 'upcoming') {
                    if (competition.registration_status === 'not_registered') {
                        actionsHtml = `<button class="btn btn-primary btn-small" onclick="registerForCompetition(${competition.id})">Register</button>`;
                    } else if (competition.registration_status === 'pending') {
                        actionsHtml = `<span class="status-badge status-pending">Registration Pending</span>`;
                    } else if (competition.registration_status === 'approved') {
                        actionsHtml = `<span class="status-badge status-approved">Registered</span>`;
                    } else if (competition.registration_status === 'rejected') {
                        actionsHtml = `<span class="status-badge status-rejected">Registration Rejected</span>`;
                    }
                } else {
                    actionsHtml = `<button class="btn btn-secondary btn-small" onclick="viewResults(${competition.id})">View Results</button>`;
                }
            } else {
                // Manager actions
                if (competition.competition_status === 'upcoming') {
                    actionsHtml = `
                        <button class="btn btn-secondary btn-small" onclick="manageRegistrations(${competition.id})">Manage (${competition.pending_registrations || 0} pending)</button>
                        <button class="btn btn-primary btn-small" onclick="editCompetition(${competition.id})">Edit</button>
                    `;
                } else {
                    actionsHtml = `<button class="btn btn-secondary btn-small" onclick="viewResults(${competition.id})">View Results</button>`;
                }
            }

            const registrationInfo = userRole === 'manager' ?
                `<div class="detail-item">
                    <span class="detail-label">üë• Registered:</span>
                    <span>${competition.approved_registrations || 0} approved, ${competition.pending_registrations || 0} pending</span>
                </div>` :
                '';

            card.innerHTML = `
                <div class="competition-header">
                    <h3>${competition.name}</h3>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
                <div class="competition-details">
                    <div class="detail-item">
                        <span class="detail-label">üìÖ Date:</span>
                        <span>${new Date(competition.competition_date).toLocaleDateString('en-AU', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        })}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">üìç Location:</span>
                        <span>${competition.location || 'TBA'}</span>
                    </div>
                    ${registrationInfo}
                </div>
                <div class="competition-actions">
                    ${actionsHtml}
                </div>
            `;

            return card;
        }

        // Filter competitions
        function filterCompetitions(filterType) {
            currentFilter = filterType;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filterType}`).classList.add('active');

            const filteredCompetitions = filterCompetitionsByType(allCompetitions, filterType);
            renderCompetitionCards(filteredCompetitions, currentUserRole);
        }

        // Register for competition
        async function registerForCompetition(competitionId) {
            if (!confirm('Are you sure you want to register for this competition? You will need approval from the competition manager to participate.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('competition_id', competitionId);

                const response = await fetch('../../api/register_competition.php', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadCompetitions(); // Refresh the list
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Registration failed. Please try again.', 'error');
            }
        }

        // Manage registrations (for managers)
        function manageRegistrations(competitionId) {
            showNotification('Registration management coming soon', 'info');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuth().then(isAuthenticated => {
                if (!isAuthenticated) {
                    return;
                }

                // Global HTMX config
                htmx.config.globalViewTransitions = true;
                htmx.config.useTemplateFragments = true;

                // Global error handling
                document.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.xhr.status >= 400) {
                        showNotification('An error occurred. Please try again.', 'error');
                    }
                });

                // Load competitions data
                loadCompetitions();

                // Handle competition form submission
                const competitionForm = document.getElementById('competition-form');
                if (competitionForm) {
                    competitionForm.addEventListener('submit', handleCompetitionSubmit);
                }
            });
        });

        // Handle competition form submission
        async function handleCompetitionSubmit(event) {
            event.preventDefault();

            // Check if user is manager
            if (currentUserRole !== 'manager') {
                showNotification('Only managers can create competitions', 'error');
                return;
            }

            const formData = new FormData(event.target);

            try {
                const response = await fetch('../../api/create_competition.php', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    hideCompetitionModal();
                    // Refresh competitions list
                    loadCompetitions();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Competition creation error:', error);
                showNotification('Failed to create competition. Please try again.', 'error');
            }
        }

        function showAddCompetitionModal() {
            // Check if user is manager
            if (currentUserRole !== 'manager') {
                showNotification('Only managers can create competitions', 'error');
                return;
            }

            document.getElementById('modal-title').textContent = 'Create New Competition';
            document.getElementById('competition-form').reset();
            document.getElementById('competition-modal').style.display = 'block';
        }

        function hideCompetitionModal() {
            document.getElementById('competition-modal').style.display = 'none';
        }

        function editCompetition(id) {
            showAddCompetitionModal();
            document.getElementById('modal-title').textContent = 'Edit Competition';
            showNotification('Edit functionality coming soon', 'info');
        }

        function viewResults(id) {
            window.location.href = 'results.html?comp=' + id;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('competition-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>